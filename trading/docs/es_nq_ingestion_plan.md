# ES/NQ Intraday Ingestion Plan

This plan explains how to give the Phase-4 density monitor the **high-density ES/NQ intraday tape** that triggers Option A in the Phase-4 briefing. The data contract matches the one the monitor already understands (`proposal_log` + `prices_csv`), while the ingestion steps ensure you keep the regime clean (5–15 min bars, moderate hazard, long trends).

## Target characteristics

* Instrument: CME ES or NQ futures (pick whichever you can source reliably).
* Frequency: 5 min (preferred) or 15 min bars.
* Duration: ≥10 trading days with contiguous sessions (no missing gaps).
* Columns:
  * `prices_csv`: `timestamp` (ISO8601), `close` (float).
  * `proposal_log`: generated by `scripts/run_proposals.py`, so it also contains `ontology_k`, `size_pred`, `i`, `action`, and the usual diagnostics.
* File layout:
  * `data/esnq/period/close.csv`
  * `logs/esnq/proposals.csv`

## Bar resolution & hazard guidance

The tape should stay on the **5–15 min** resolution window because:

* Phase-4 needs persistent *size choices* without being overwhelmed by microstructure `hazard` spikes (see `TRADER_CONTEXT2.md` around the hazard discussion and `hazard` teacher logic).
* Too-short bars (<5 min) increase hazard veto counts and collapse T/R mass.
* Too-long bars (>15 min) dilute actionable T/R events and slow density accumulation.

Start at 5 min, and only jump to 10–15 min if the hazard filter is tripping often: a higher hazard (burstiness/volatility) implies you need a coarser resolution to keep ACT windows long enough for size bins to separate.

## Ingestion workflow

1. **Acquire price bars**
   * Export 5–15 min OHLCV from your vendor as CSV.
   * Keep only `timestamp` + `close` (optionally `volume` for future diagnostics); rename to `close.csv`.
   * Place the file under `data/esnq/<instrument>/<resolution>/close.csv`.

2. **Generate proposals**
   * Reuse `scripts/run_proposals.py` with the QFeat tape and the same price file:
     ```bash
     python scripts/run_proposals.py \
       --tape data/esnq/ES_5m/tape.memmap \
       --series 0 \
       --prices-csv data/esnq/ES_5m/close.csv \
       --proposal-log logs/esnq/ES_5m/proposals.csv \
       --options-source synthetic \
       --perp-w-dirconf 1.2 \
       --tag esnq
     ```
   * Make sure the generated CSV includes `ts`, `i`, `action`, `ontology_k`, and `size_pred`.

3. **Point the density monitor**
   * Use `scripts/phase4_density_monitor.py` or the new runner (see below) with:
     ```
     --target ES=logs/esnq/ES_5m/proposals.csv,data/esnq/ES_5m/close.csv
     --target NQ=logs/esnq/NQ_5m/proposals.csv,data/esnq/NQ_5m/close.csv
     ```
   * Keep the `--interval` high enough to avoid redundant processing (e.g., 600 s).

4. **Monitor and react**
   * Watch `logs/phase4/density_monitor.log` for the debounced `OPEN → OPEN` transition.
   * When the gate opens, run `scripts/train_size_per_ontology.py` with `--init-weights` to execute Phase-4.1.

## Verifying the ingestion contract

Before you declare the monitor “waiting for density,” prove the pipeline is seeing the new tape by running:

```
python scripts/check_esnq_ingestion.py --config configs/phase4_monitor_targets.json --log logs/phase4/density_monitor.log
```

The helper loads the same `proposal_log`+`prices_csv` targets the monitor uses, checks the files exist and expose the required columns (`ts`, `action`, `ontology_k`, `size_pred` on the proposals and `timestamp`, `close` on the prices), and reports the latest `gate_open` verdict plus `blocking_reason` per target so you have a concrete label for each closed run. Run this after every ingestion refresh so you have a traceable “contract passed / contract pending” log when Phase-4.1 eventually opens.

## Notes

* The ES/NQ tape should have fewer hazard vetoes than BTC because futures have deeper liquidity; this makes `T/R` counts accumulate faster.
* Keep the proposals/prices contract identical to BTC so you can reuse the same monitor and Phase-5 scripts without modification.
